external function string 255 removenextnode(var string);external function string 255 FormatSimpleLink(string,boolean);//webngexternal procedure RedirectToURL(string);//pagesexternal procedure ShowWebAppPageStart(record WebNGPageVc,string);external procedure ShowWebAppPageEnd(record WebNGPageVc);//stdexternal function string 255 GetNextValue(var string);external function boolean IsNumeric(string);external function string 10 CurrentWebLang();external function integer GetJAlCustType(record CUVc,var record SMFVc,var record TeacherVc,var record MentorVc);external function string 255 toolwebngtranslatetext(integer);external procedure ShowRedirectHtml(string,boolean);external procedure ExtractObj(string,var Integer,var string);external function string 255 CreateJson(string);function boolean ToolFindMatchingTranslation(string code,var record WebNGTranslateVc WTr,string lang)begin  boolean res,foundf;  res = false;  foundf = true;  ResetLoop(WTr);  WTr.LangCode = lang;  while (LoopKey("EventLangCode:" & code,WTr,2,foundf)) begin    if WTr.LangCode <> lang then begin      foundf = false;    end else begin      foundf = false;      res = true;    end;  end; ToolFindMatchingTranslation = res;return;end;function boolean FindFilledEntry(var record CUVc CUr,var record JALEventEntryVc JEEr,var integer type,longint nr)begin  record SMFVc SMFr;  record TeacherVc TCr;  record MentorVc MTr;  boolean res;  res = false;  if nonblank(CurrentCust) then begin    CUr.Code = CurrentCust;    if readfirstmain(Cur,1,true) then begin      type = GetJAlCustType(CUr,SMFr,TCr,MTr);      JEEr.CustType = type;      JEEr.EventNr = nr;      switch type begin        case 0: JEEr.AddCode = SMFr.SMFCode;        case 1: JEEr.AddCode = TCr.TeacherCode;        case 2: JEEr.AddCode = MTr.MentorCode;      end;      if readfirstkey("CustType",JEEr,3,true) then begin        res = true;      end;    end;  end;  FindFilledEntry = res;return;end;function string 255 removelastnode(string path)begin  string 255 res;  integer pos,i;  res = "";  pos = 0;  for (i = len(path)-1; i>=0; i = i - 1) begin    if (mid(path,i,1) == "/") then begin      pos = i;      i = 0;    end;  end;  res = mid(path,0,pos);  removelastnode = res;return;end;globalfunction boolean FindMatchingTranslation(string code,var record WebNGTranslateVc WTr,string def)begin  boolean res;  res = false;  if ToolFindMatchingTranslation(code,WTr,CurrentWebLang) then begin    res = true;  end else begin    if ToolFindMatchingTranslation(code,WTr,def) then begin      res = true;    end;  end;  FindMatchingTranslation = res;return;end;function boolean EventHasNextStep(record JALEventVc JEr,var string step)begin  row JALEventVc JErw;  integer i,rwcnt;  boolean res;  record JALEventFieldVc JFr;  res = false;  rwcnt = MatRowCnt(JEr);  for (i = 0; i < rwcnt; i = i + 1) begin    MatRowGet(JEr,i,JErw);    if (JErw.Show == 0) or (JErw.Show == 1 and blank(CurrentCust)) or (JErw.Show == 2 and nonblank(CurrentCust)) then begin      JFr.SerNr = JErw.Field;      if readfirstmain(JFr,1,true) then begin        step = "reg";        res = true;      end;    end;  end;  EventHasNextStep = res;return;end;procedure ShowEventContent(record JALEventVc JEr,string path)begin  record WebNGTranslateVc WTr;  boolean testf;  string 10 step;    if FindMatchingTranslation(JEr.SerNr,WTr,JEr.DefLangCode) and JEr.ActiveFlag == 1 then begin    WebOutStringFormatNL("<div class='header'>" & WTr.Comment & "</div>");    if nonblank(GetSessionString("msg")) then begin      WebOutStringFormatNL("<div class='msg'>" & GetSessionString("msg") & "</div>");      PutSessionString("msg","");    end;    WebOutStringFormatNL("<div class='main' >");    WebOutText(WTr,WTr.HtmlTranslation==1,"");    WebOutStringFormatNL("</div>");     WebOutStringFormatNL("<div class='part_link'>");    testf = false;    if JEr.RegFlag == 1 then begin      if blank(CurrentCust) then begin        testf = false;      end else begin        testf = true;      end;    end else begin      testf = true;    end;    if testf  then begin      if EventHasNextStep(JEr,step) then begin        WebOutStringFormatNL("<a href='/" & FormatSimpleLink(path,true) & "/" & step & "'>" & ToolWebNGTranslateText(26200) & "</a>");      end else begin        WebOutStringFormatNL("<a href='/" & FormatSimpleLink("WebJALEventReg.hal?event=" & JEr.SerNr  &"&path=" & path & "/reg",true) & "'>" & ToolWebNGTranslateText(26200) & "</a>");      end;    end else begin      WebOutStringFormatNL("<a href='/login'>" & ToolWebNGTranslateText(26201) & "</a>");    end;    WebOutStringFormatNL("</div>");     end else begin    WebOutStringFormatNL(ToolWebNGTranslateText(26202));  end;  return;end;function string 150 GetFieldLabel(record JALEventFieldVc JFr)begin  row JALEventFieldVc JFrw;  integer i,rwcnt;  string 20 lang;  string 150 res;  lang = CurrentWebLang;  res = JFr.Text;  rwcnt = MatRowCnt(JFr);  for (i = 0; i < rwcnt;i = i + 1) begin    MatRowGet(JFr,i,JFrw);    if JFrw.LangCode == lang then begin      res = JFrw.Comment;      i = rwcnt;    end;  end;  GetFieldLabel = res;return;end;procedure ShowSimpleSelectBox(integer rw,record JALEventFieldVc JFr,row JALEventVc JErw,string value)begin  record JALEventSelectBoxVc JSr;  row JALEventSelectBoxVc JSrw;  integer i,rwcnt,pos;  string 255 field,res;  string 20 lang;  lang = CurrentWebLang;    JSr.SerNr = JFr.SelectBox;  if readfirstmain(JSr,1,true) then begin    field = JSr.Text;    rwcnt = MatRowCnt(JSr);    for (i = 0; i < rwcnt;i = i + 1) begin      MatRowGet(JSr,i,JSrw);      if JSrw.LangCode == lang then begin        field = JSrw.Comment;        i = rwcnt;      end;    end;  end;  WebOutStringFormatNL("<div class='event_reg_line'>");  WebOutStringFormatNL("<div class='event_reg_field'>");  //WebOutStringFormatNL("<input type='text' class='event_reg' value='" & value & "' name='event_reg_field_" & rw & "' >");  WebOutStringFormatNL("<select type='text' class='event_reg' name='event_reg_field_" & rw & "' >");  WebOutStringFormatNL("<option value=''>" & ToolWebNGTranslateText(26203) & "</div>");  pos = 0;  ExtractObj(field,pos,res);  while (nonblank(res)) begin    if value == res then begin      WebOutStringFormatNL("<option selected value='" & res & "'>" & res & "</div>");    end else begin      WebOutStringFormatNL("<option value='" & res & "'>" & res & "</div>");    end;    ExtractObj(field,pos,res);  end;      WebOutStringFormatNL("</select>");  WebOutStringFormatNL("</div>");  WebOutStringFormatNL("<div class='event_reg_label'>");  WebOutStringFormatNL(GetFieldLabel(JFr));  if JErw.Req == 0 then begin    WebOutStringFormatNL("*");  end;  WebOutStringFormatNL("</div>");  WebOutStringFormatNL("</div>");return;end;procedure ShowSimpleField(integer rw,record JALEventFieldVc JFr,row JALEventVc JErw,string value)begin  WebOutStringFormatNL("<div class='event_reg_line'>");  WebOutStringFormatNL("<div class='event_reg_field'>");  WebOutStringFormatNL("<input type='text' class='event_reg' value='" & value & "' name='event_reg_field_" & rw & "' >");  WebOutStringFormatNL("</div>");  WebOutStringFormatNL("<div class='event_reg_label'>");  WebOutString(GetFieldLabel(JFr));  if JErw.Req == 0 then begin    WebOutStringFormatNL("*");  end;  WebOutStringFormatNL("</div>");  WebOutStringFormatNL("</div>");return;end;function string 255 getEntryValue(record JALEventEntryVc JEEr,longint field)begin  row JALEventEntryVc JEErw;  integer i,rwcnt;  string 255 res;  res = "";  rwcnt = MatRowCnt(JEEr);  for (i = 0; i < rwcnt;i = i + 1) begin    MatRowGet(JEEr,i,JEErw);    if JEErw.Field == field then begin      res = JEErw.Value;      i = rwcnt;    end;  end;  getEntryValue = res;return;end;procedure ShowSimpleUploadForm(integer rw,record JALEventFieldVc JFr,row JALEventVc JErw)begin  WebOutStringFormatNL("<div class='event_reg_line'>");  WebOutStringFormatNL("<div class='event_reg_field'>");  WebOutStringFormatNL("<iframe src='/WebJALShowUploadForm.hal?path=/WebJALShowUploadForm.hal'></iframe>");  WebOutStringFormatNL("</div>");  WebOutStringFormatNL("<div class='event_reg_label'>");  WebOutString(GetFieldLabel(JFr));  if JErw.Req == 0 then begin    WebOutStringFormatNL("*");  end;  WebOutStringFormatNL("</div>");  WebOutStringFormatNL("</div>");return;end;procedure ShowRegistrationFields(record JALEventVc JEr,var boolean uplf,boolean foundf,record JALEventEntryVc JEEr) begin  boolean editf;  row JALEventVc JErw;  integer i,rwcnt;  record JALEventFieldVc JFr;  string 255 value;    rwcnt = MatRowCnt(JEr);    if GetSessionString("editf")== "true" then begin      editf = true;      PutSessionString("editf","");    end else begin      editf = false;    end;    for (i = 0; i < rwcnt;i = i + 1) begin      MatRowGet(JEr,i,JErw);      if (JErw.Show == 0) or (JErw.Show == 1 and blank(CurrentCust)) or (JErw.Show == 2 and nonblank(CurrentCust)) then begin        JFr.SerNr = JErw.Field;        if readfirstmain(JFr,1,true) then begin          value = "";          if foundf then begin            value = getEntryValue(JEEr,JFr.SerNr);          end;          if editf then begin            value = getSessionString("event_reg_field_" & i);          end;          switch JFr.Type begin            case 0: ShowSimpleField(i,JFr,JErw,value);            case 1: ShowSimpleSelectBox(i,JFr,JErw,value);            case 3: ShowSimpleField(i,JFr,JErw,value);            case 2: ShowSimpleUploadForm(i,JFr,JErw);          end;        end;      end;    end;return;end;procedure ShowEventSubPage(record JALEventVc JEr,string node,string path)begin  boolean uplf;  record CUVc CUr;  record SMFVc SMFr;  record TeacherVc TCr;  record MentorVc MTr;  record JALEventEntryVc JEEr;  integer type;  boolean foundf;  record WebNGTranslateVc WTr;  uplf = false;    if FindMatchingTranslation(JEr.SerNr,WTr,JEr.DefLangCode) and JEr.ActiveFlag == 1 and JEr.ClosedFlag == 0  then begin    WebOutStringFormatNL("<div class='header'>" & WTr.Comment & "</div>");    WebOutStringFormatNL("<form method='POST' action='/WebJALEventReg.hal'>");    WebOutStringFormatNL("<input type='hidden' name='path' value='" & WebGetArg("path") & "'>");    WebOutStringFormatNL("<input type='hidden' name='event' value='" & JEr.SerNr & "'>");        if GetSessionString("error") == "true" then begin      WebOutStringFormatNL("<div class='event_err'>");      PutSessionString("error","");      if GetSessionString("err_email") == "true" then begin        WebOutStringFormatNL(ToolWebNGTranslateText(26204));        PutSessionString("err_email","");      end else begin        WebOutStringFormatNL(ToolWebNGTranslateText(26205));      end;      WebOutStringFormatNL("</div>");    end;    foundf = FindFilledEntry(CUr,JEEr,type,JEr.SerNr);            switch node begin      case "reg": ShowRegistrationFields(JEr,uplf,foundf,JEEr);    end;    //WebOutStringFormatNL("<div class='submit_line'><input type='button' onclick='location.href=""" & FormatSimpleLink(removelastnode("/" & path),true) & """' class='spbutton first' value='" & ToolWebNGTranslateText(26206) & "'><input type='submit' class='spbutton' value='" & ToolWebNGTranslateText(26207) & "'></div>");    WebOutStringFormatNL("<div class='submit_line'><input type='submit' class='spbutton' value='" & ToolWebNGTranslateText(26207) & "'></div>");    WebOutStringFormatNL("</form>");  end;return;end;procedure ShowEventList(string path)begin  record JALEventVc JEr;  boolean TrHs;  record WebNGTranslateVc WTr;  TrHs = true;  ResetLoop(JEr);  JEr.ActiveFlag = 1;  JEr.StartDate = addYear(CurrentDate,-3);  WebOutStringFormatNL("<ul class='list' >");  while loopkey("Active",JEr,2,Trhs) begin    if JEr.ActiveFlag <> 1 then begin      TrHs = false;    end else begin      if FindMatchingTranslation(JEr.SerNr,WTr,JEr.DefLangCode) and JEr.ClosedFlag == 0 then begin        WebOutStringFormatNL("<li>");          WebOutStringFormatNL("<a href='" & FormatSimpleLink(path,true) & "/" & JEr.SerNr & "'><div class='event_list_head'>" & WTr.Comment & "</div><div class='event_list_date'>" & JEr.StartDate & "</div></a>");        WebOutStringFormatNL("</li>");      end;    end;  end;  WebOutStringFormatNL("</ul>");return;end;globalprocedure EventAppHandler(record WebNGStructVc WSr,string path,string rpath)begin  record WebNGPageVc WPr;  string 30 mpath,node;  record JALEventVc JEr;    WPr.Code = WSr.WebPage;  if (nonblank(WPr.Code)) then begin    if (ReadFirstMain(WPr,1,true)) then begin end;  end;  ShowWebAppPageStart(WPr,"");  mpath = path;  node = removenextnode(mpath);  WebOutStringFormatNL("<div class='event_page'>");  if (IsNumeric(node) and nonblank(node)) then begin    JEr.SerNr = StringToLongInt(node);    if readfirstmain(JEr,1,true) then begin      node = removenextnode(mpath);      if blank(node) then begin        ShowEventContent(JEr,rpath);      end else begin        if (JEr.RegFlag == 1 and nonblank(CurrentCust)) or (JEr.RegFlag == 0) then begin          ShowEventSubPage(JEr,node,rpath);        end;      end;    end;  end else begin    ShowEventList(rpath);  end;  WebOutStringFormatNL("</div>");   ShowWebAppPageEnd(WPr);return;end;procedure ClearEntryRows(var record JALEventEntryVc JEEr)begin  integer i,rwcnt;  rwcnt = MatRowCnt(JEEr);  for (i = rwcnt-1;i >= 0; i = i - 1) begin    MatRowDelete(JEEr,i);  end;return;end;updating procedure FillEntryRows(var record JALEventEntryVc JEEr,record JALEventVc JEr,var boolean err,var boolean uplf,var boolean reqf)begin  row JALEventEntryVc JEErw;  row JALEventVc JErw;  integer i,rwcnt;  record JALEventFieldVc JFr;  record CUVc CUr;  string 255 fname;    rwcnt = MatRowCnt(JEr);  for (i = 0; i < rwcnt;i = i + 1) begin    MatRowGet(JEr,i,JErw);    if (JErw.Show == 0) or (JErw.Show == 1 and JEEr.CustType == 3) or (JErw.Show == 2 and JEEr.CustType <> 3) then begin        JFr.SerNr = JErw.Field;      if readfirstmain(JFr,1,true) then begin        if JFr.Type <> 2 then begin          if JFr.Type == 3 then begin            CUr.eMail = WebGetArg("event_reg_field_" & i);            if nonblank(CUr.eMail) and readfirstkey("eMail",CUr,1,true)==false then begin              JEErw.Field = JErw.Field;              JEErw.Comment = JErw.Comment;              JEErw.Value = WebGetArg("event_reg_field_" & i);              MatRowPut(JEEr,MatRowCnt(JEEr),JEErw);                        end else begin              err = true;              if nonblank(WebGetArg("event_reg_field_" & i)) then begin                putSessionString("err_email","true");              end;            end;          end else begin            ClearRow(JEEr,JEErw,1);            JEErw.Field = JErw.Field;            JEErw.Comment = JErw.Comment;            JEErw.Value = WebGetArg("event_reg_field_" & i);            MatRowPut(JEEr,MatRowCnt(JEEr),JEErw);            if JErw.Req == 0 and blank(JEErw.Value) then begin              err = true;            end;          end;          PutSessionString("event_reg_field_" & i,WebGetArg("event_reg_field_" & i));        end else begin          reqf = JErw.Req==0;          uplf = true;        end;      end;    end;  end;return;end;global webpublicupdating procedure WebJALEventReg()begin  record CUVc CUr;  record SMFVc SMFr;  record TeacherVc TCr;  record MentorVc MTr;  integer type;  boolean err,testf,foundf,nextf;  record JALEventEntryVc oldJEER,JEEr;  record JALEventVc JEr;  string 255 path;  string 255 fname;  boolean uplf,reqf;  err = false;  nextf = false;    JEr.SerNr = StringToLongInt(WebGetArg("event"));  if readfirstmain(JEr,1,true) then begin    testf = true;    if JEr.RegFlag == 1 and blank(CurrentCust) then begin      testf = false;    end;    if JEr.ActiveFlag == 0 then begin      testf = false;    end;    if testf then begin      foundf = FindFilledEntry(CUr,JEEr,type,JEr.SerNr);      if foundf then begin        recordCopy(oldJEEr,JEEr);        ClearEntryRows(JEEr);      end else begin        RecordNew(JEEr);        JEEr.SerNr = NextSerNr("JALEventEntryVc",CurrentDate,-1,false,"");        JEEr.TransDate = CurrentDate;        if nonblank(CurrentCust) then begin          JEEr.CustType = type;          JEEr.CustCode = CUr.Code;          type =  GetJAlCustType(CUr,SMFr,TCr,MTr);          switch type begin            case 0:JEEr.AddCode = SMFr.SMFCode;            case 1:JEEr.AddCode = TCr.TeacherCode;            case 2:JEEr.AddCode = MTr.MentorCode;          end;        end else begin          JEEr.CustType = 3;        end;      end;      //fill registration fields      uplf = false;      reqf = true;      FillEntryRows(JEEr,JEr,err,uplf,reqf);      if err == false then begin        if uplf and !foundf then begin          if reqf == true and (blank(getSessionString("event_upload_file")) or FileExists("webcust/content/" & getSessionString("event_upload_file"))==false) and !foundf then begin            err = true;          end;        end;      end;      if err == false then begin        PutSessionString("msg",ToolWebNGTranslateText(26208));        if foundf then begin          if recordUpdate(oldJEEr,JEEr,true)==0 then begin            nextf = true;          end;        end else begin          JEEr.EventNr = JEr.SerNr;          if recordStore(JEEr,true) then begin            nextf = true;          end;        end;        if uplf then begin          fname = "webcust/content/" & GetSessionString("event_upload_file");          if fileExists(fname) then begin            RecordLinkFile(fname,0,JEEr,CurrentCompany);            PutSessionString("event_upload_file","");            PutSessionString("event_upload_realfile","");            Delete_File(fname);          end;        end;      end else begin        PutSessionString("error","true");      end;    end;  end;  if nextf then begin    path = removelastnode(WebGetArg("path"));    ShowRedirectHTML(FormatSimpleLink(path,true),false);    end else begin    PutSessionString("editf","true");    ShowRedirectHTML(FormatSimpleLink(WebGetArg("path"),true),false);  end;return;end;global webpublicprocedure WebJALShowUploadForm()begin  string 100 ast;  integer i;  string 2 tstr;  integer pos;  string 15 res;  res = "";  Randomize;  ast = "0F3481ADE786F29523AAADECCBB123456FF987C2A3B4D6DD7EE8F922F33E5"; // 61 characters  for (i=0;i<12;i=i+1) begin    pos = Random(0,60);    tstr = Mid(ast,pos,1);    res = res & tstr;      end;  WebOutStringFormatNL("<html><head><link rel='stylesheet' type='text/css' href='/upld_form.css'></head><body>");  if getSessionString("event_upload_file") == "" or FileExists("webcust/content/" & getSessionString("event_upload_file"))==false then begin    PutSessionString("event_upload_file","")    PutSessionString("event_upload_ses",res);      WebOutStringFormatNL("<form method='POST' action='http://jal.lv:8081/upload.php?v=" & res & "' enctype='multipart/form-data'>");    WebOutStringFormatNL("<div><input type=""file"" name=""userfile"" size=""40""></div>");    //WebOutStringFormatNL("<input type='hidden' name='s' value='" & res & "'>");    WebOutStringFormatNL("<div class=""uploadline2""><input id=""changesbutton"" type=""submit"" value=""" & ToolWebNGTranslateText(25547) & """>");    WebOutSTringFormatNL("</form>");    PutSessionString("event_upload_path",WebGetArg("path"));  end else begin    if nonblank(getSessionString("event_upload_realfile")) then begin      WebOutStringFormatNL("<div class=''>" & getSessionString("event_upload_realfile") & "</div>");    end else begin      WebOutStringFormatNL("<div class=''>" & getSessionString("event_upload_file") & "</div>");    end;  end;  WebOutStringFormatNL("</body></html>");  return;end;global webpublicprocedure WebJALEventUploadFunc()begin  string 100 path;  Area FileArea,img,FADone;  string 255 filename;  integer enter;  longint lcnt,pos,spos,epos,pepos;  string 255 tstr,namestr;  boolean getnamef;  integer namepos,nameepos,i;  record CUVc CUr;  record WebNGStructVc WSr;  string 255 link;  record SMFVc SMFr;  record RLinkVc RLr;  record JALFileVc JFr;  record JALClassBlock JCbl;  boolean savef;  path = "webcust/content/";  namepos = 0;  nameepos = 0;  savef = true;  enter = 0;  pos = 0;  epos = -1;  spos = 0;  if nonblank(GetSessionString("event_upload_ses")) then begin    putSessionString("event_upload_ses","");    WebGetPostData(FileArea);    while pos < GetAreaLength(FileArea)+1 begin            tstr = GetStringFromArea(FileArea,pos,1);               pos = pos + 1;      if tstr == chr(13) then begin        enter = enter + 1;        pepos = epos;        epos = pos - 1;        if enter == 1 then begin          namepos = pos + 1;        end;        if enter == 2 then begin          nameepos = pos - 1;        end;        if enter == 4 then begin          spos = pos+1;        end;      end;    end;          namestr = GetStringFromArea(FileArea,namepos,nameepos-namepos);    for (i = 0; i < len(namestr); i = i + 1) begin      if mid(namestr,i,9) == "filename=" then begin        filename = mid(namestr,i+10,len(namestr) - (i + 11));      end;    end;    if filename <> "" then begin      LogText(0,"Picture is being uploaded");      CreateFile(path & filename);      CloseFile;      GetAreaFromArea(FileArea,spos,pepos-spos,FADone);      WRITEAREATOFILE(FADone,path & filename,0);      PutSessionString("event_upload_file",filename);      NewTimedTask("deletefile" & filename & "_" & currentTime,"Delete uploaded file","RemoveUploadedFile",filename,currentDate,AddMinutes(CurrentTime,20),"","");    end;  end;    link = GetSessionString("event_upload_path");  PutSessionString("event_upload_path","");  ShowRedirectHtml(FormatSimpleLink(link,true),false);return;end;global procedure RemoveUploadedFile(string fname)begin  string 255 filename;  filename = "webcust/content/" & fname;  if (FileExists(filename)) then begin    Delete_File(filename);  end;return;end;global webpublicprocedure WebRecordLinkFiles()begin  record JALClassBlock JCbl;  boolean err;  boolean res;  string 255 uplf,path,frfolder,nm,tofolder,filename,rn;  BlockLoad(JCbl);  uplf = JCbl.UploadDir;  path = "webcust/content/";  frfolder = uplf;  filename = WebGetArg("cn");  rn = WebGetArg("rn");  nm = uplf & filename;  if nonblank(GetSessionString("event_upload_ses")) then begin    if (FileExists(nm)) then begin      tofolder = path;      err = MoveFile(filename,frfolder,tofolder);      delete_File(nm);            PutSessionString("event_upload_file",filename);      PutSessionString("event_upload_realfile",rn);      NewTimedTask("deletefile" & filename & "_" & currentTime,"Delete uploaded file","RemoveUploadedFile",filename,currentDate,AddMinutes(CurrentTime,20),"","");    end;  end;  ShowRedirectHtml(FormatSimpleLink("/WebJALShowUploadForm.hal",true),false);return;end;global webpublicprocedure FutureEvents()begin	record WebNGTranslateVc NGr;	record JALEventVc JEr;	if(WebLoginStatus==3)then begin			JEr.SerNr = "";			while(LoopMain(JEr,1,true)) begin				if(JEr.StartDate > AddDay(CurrentDate,-365)) then begin					WebOutStringFormatNL("\"let eventInfo\" = " & "{");					WebOutStringFormatNL("\"dataStart\":\"" & JEr.StartDate & "\",");					WebOutStringFormatNL("\"dataEnd\":\"" & JEr.EndDate & "\",");					WebOutStringFormatNL("\"nameEvent\":\"" & JEr.Comment & "\",");					NGr.Code = JEr.SerNr;					NGr.LangCode = "LV";					NGr.FileName = 5;					ReadFirstMain(NGr,3,true);					WebOutStringFormatNL("\"nameEvent\":\"");					WebOutText(NGr,true,""); WebOutStringFormatNL("\"}");					WebOutStringFormatNL("};");				end;			end;		end else begin		weboutstring("{\"result\":\"Error Login\"}");	end;return;end;global webpublicprocedure WebGetNolicune()begin	record  MailVc Mailr;	record ConfVc Confr;	string 255 userkey,docNr,name;	integer cnt;	record RLinkVc RLr;	integer notenr;	record Attach2Vc JFr;	if(WebLoginStatus==3)then begin		userkey="UserTime:" & 1074;		WebOutStringFormatNL("[{");//		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":"&"\"Citi\",");		WebOutStringFormatNL("\"docs\":[");		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin			if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end; 		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					if(LineTextCnt(Mailr)==0) then begin						WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutStringFormatNL("\"}");					end else begin							WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");					end;					end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":"&"\"finansu pratiba\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1073;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin				if(LineTextCnt(Mailr)==0) then begin						WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutStringFormatNL("\"}");					end else begin						WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");					end;				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":"&"\"Karjera\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1072;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin			if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr;  end;		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin				if(LineTextCnt(Mailr)==0) then begin						WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutStringFormatNL("\"}");					end else begin						WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");					end;				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":"&"\"Iznemejbardiba\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1071;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin			if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end; 		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					if(LineTextCnt(Mailr)==0) then begin						WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutStringFormatNL("\"}");					end else begin						WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");					end;				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]");		WebOutStringFormatNL("}]");	end;return;end;global webpublicprocedure WebGetMaterials()begin	record  MailVc Mailr;	record ConfVc Confr;	string 255 userkey,docNr,name;	integer cnt;	record RLinkVc RLr;	integer notenr;	record Attach2Vc JFr;	if(WebLoginStatus==3)then begin		userkey="UserTime:" & 1075;		WebOutStringFormatNL("[{");//		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"1-9 Klassu materiali\",");		WebOutStringFormatNL("\"docs\":[");		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin			if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end; 		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr:\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"vebinari un citi materiali\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1076;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr:\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"darbibai nepieciesamie dokumenti\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1077;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr:\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]");		WebOutStringFormatNL("}]");	end;return;end;global webpublicprocedure WebGetConf()beginrecord ConfVc Cr;while(LoopMain(Cr,1,true)) beginWebOutStringFormatNL("ser-" & Cr.SerNr & "name-" & Cr.AddrName);end;return;end;global webpublicprocedure WebGetMaterialsHigh()begin	record  MailVc Mailr;	record ConfVc Confr;	string 255 userkey,docNr,name;	integer cnt;	record RLinkVc RLr;	integer notenr;	record Attach2Vc JFr;	if(WebLoginStatus==3)then begin		userkey="UserTime:" & 1077;		WebOutStringFormatNL("[{");//		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"SMU darb. nepiec. dok.\",");		WebOutStringFormatNL("\"docs\":[");		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin			if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end; 		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"Komerczinibu materials-vidusski\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1078;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"Prof. skolu komercz. mod\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1079;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":");WebOutText( Mailr,true,"");				end;		end;			ResetLoop(Mailr);			WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"GREENT mat. un stundu plan\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1080;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":"); WebOutText( Mailr,true,"");				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"Biznesa plana veidosana\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1081;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			ResetLoop(Mailr);			WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"JA TITAN materiali\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1082;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			ResetLoop(Mailr);		WebOutStringFormatNL("]},");		WebOutStringFormatNL("{");		WebOutStringFormatNL("\"nameConf\":" & "\"Vebinari un citi materiali\",");		WebOutStringFormatNL("\"docs\":[");		userkey="UserTime:" & 1076;		cnt = 0;		While(LoopKey(userkey,Mailr,1,true)) begin		if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			if(ReadRecordLink(Mailr,1,JFr,RLr)) then begin	if(JFr.SerNr==-1) then begin docNr = ""; end else begin docNr=JFr.SerNr; end;  		end;				name = CreateJson(Mailr.Header);				if(Mailr.HasFileAtt!=0) then begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"serNr\":\"" & docNr & "\"}");				end else begin					WebOutStringFormatNL("{\"nameDoc\":\"" & name &"\",\"link\":\"");WebOutText( Mailr,true,"");WebOutStringFormatNL("\"}");				end;		end;			WebOutStringFormatNL("]");		WebOutStringFormatNL("}]");	end;return;end;global procedure JsonCreator1(array string objects, array string value, integer count )begininteger i,cnt,j;WebOutStringFormatNL("[");cnt = 0;for (i=0;i<count;i=i+1) begin if(cnt>0) then begin WebOutStringFormatNL(","); end;			cnt = cnt + 1;			WebOutStringFormatNL("{");			for(j=0;j<objects.length;j=j+1) begin						WebOutStringFormatNL("\"" & objects[j] & "\":\"" & value[i*count + j] & "\""); 				if(j!=objects.length - 1) then begin  WebOutStringFormatNL(","); end;			end;			WebOutStringFormatNL("}");	end;		WebOutStringFormatNL("]");	return;end;global webpublic procedure WebDownloadDocs()begin record Attach2Vc Attachr;string 20 serNr;WebSetContentType("application/binary");serNr = webGetArg("code");WebOutAttachment(serNr);return;end;global webpublic procedure Webjsontest()beginarray string 20 object,value;object[0] = "test";object[1] = "test1";value[0] = "te";value[1] = "tes";value[2] = "te1";value[3] = "tes2";JsonCreator1(object,value,2);return;end;