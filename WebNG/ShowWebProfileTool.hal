external function string 255 FormatSimpleLink(string,boolean);external procedure ShowRedirectHtml(string,boolean);external updating procedure GenMailForSMU(string,string,string,var record SMFVc,boolean,record CUVc,string);external function boolean CheckEmailStr(string);external function string 255 GetLinkToStruct(LongInt,boolean);external function Boolean GetNextCustNr(var string);external function Boolean FindSMURecord(string,var record SMFVc);external function Boolean FindTchrRecord(string,var record TeacherVc);// Edit ************************** BPI Ukraine - KramarAlexandr - Tuesday, 6 November 2018 14:28:54function string 255 GenerateRandomHash()begin  string 100 ast;  LongInt pos,length;  LongInt i;  string 255 res,tstr;    length = 20;  res = "";  Randomize;  ast = "0f3481ade786F29523aaadeccbb123456ff987C2a3b4d6dd7ee8f922f33e5"; // 61 characters  for (i=0;i<length;i=i+1) begin    pos = Random(0,60);    tstr = Mid(ast,pos,1);    res = res & tstr;      end;  GenerateRandomHash = res;return;end;global webpublicupdating procedure WebDeleteEmp()begin  record CUVc CUr,oldCUr,tCUr;  record SMFVc SMFr;  record RLinkVc RLr;  boolean res;  integer i;  CUr.Code = WebGetArg("emp");    if readfirstmain(CUr,1,true) begin    if readrecordlink(CUr,1,SMFr,RLr) or FindSMURecord(CurrentCust,SMFr) begin      if SMFr.SMFCode == WebGetArg("smu") then begin        RecordRemove(RLr);        //RecordCopy(oldCUr,CUr);        //CUr.blockedFlag = 1;        //if recordupdate(oldCUr,CUr,true)==0 then begin end;        res = true;        i = 1;        while readrecordlink(SMFr,i,tCUr,RLr) and res begin          if tCUr.Code == CUr.Code then begin            RecordRemove(RLr);            res = false;          end;          i = i + 1;        end;      end;    end;  end;    ShowRedirectHTML(FormatSimpleLink(WebGetArg("tpath"),true),false);  return;end;global webpublic updating procedure WebChangeProfile()begin  record SMFVc SMFr,oldSMFr;  record CUVc CUr;  integer err;  string 30 name,comp,cust;  boolean savef;  record RLinkVc RLr;  string 10 cls;  string 255 prspec;  err = 0;  name = WebGetArg("name");  comp = WebGetArg("smu");  cust = WebGetArg("emp");  cls = WebGetArg("prclass");  prspec = WebGetArg("prodinfo");  if blank(name) then begin    err = err + 2;  end else begin    SMFr.SMFName = name;    if readfirstKey("SMFName",SMFr,1,true) then begin      if comp <> SMFr.SMFCode then begin        err = err + 2;      end;    end;  end;  savef = false;  if err == 0 then begin    CUr.Code = cust;    if readfirstmain(CUr,1,true) begin      if readrecordlink(CUr,1,SMFr,RLr) or FindSMURecord(CUr.Code,SMFr) begin        if SMFr.SMFCode == comp then begin          RecordCopy(oldSMFr,SMFr);          SMFr.SMFName = name;          SMFr.Objects = cls;          SMFr.ProdSpec = prspec;          SMFr.ReadyFlag = 1;          WebGetText("comment",SMFr);          if recordupdate(oldSMFr,SMFr,true)==0 then begin end;          savef = true;        end;      end;    end;  end;    PutSessionString("err",err);  ShowRedirectHTML(FormatSimpleLink(WebGetArg("tpath"),true),false);return;end;global webpublicupdating procedure WebSaveCompEmp()begin  record CUVc CUr,tCUr,oldCUr,cCUr;  record SMFVc SMFr;  string 100 name,email,cust,comp,tstr,passw2,tstr2;  record JALClassBlock JALClassbl;  boolean TrHs;  record SchoolVc SCr;  integer err;  boolean foundf,savef;  record RLinkVc RLr;  string 255 text;  err = 0;  BlockLoad(JALClassbl);    comp = webgetArg("smu");  cust = webGetArg("cust");  name = WebGetArg("name");  email = WebGetArg("email");  tstr = WebGetArg("passw1");  passw2 = WebGetArg("passw2");  if blank(tstr) then begin    err = err + 32;  end else begin    if tstr <> passw2 then begin      err = err + 64;    end;  end;  if blank(name) then begin    err = err + 2;  end;  foundf = false;  if blank(email) then begin    err = err + 4;  end else begin    if CheckEmailStr(email) == false then begin      err = err + 8;    end else begin      tCUr.eMail = email;      TrHs = true;      if readfirstkey("eMail",tCUr,1,true) begin        //if SetInSet(JALClassbl.EventPart,tCUr.Classification)==false and (tCUr.blockedFlag == 0) then begin          //err = err + 16;        //end else begin          foundf = true;        //end;      end;    end;  end;  savef = false;  if err == 0 then begin        CUr.Code = cust;    cCUr.Code = CurrentCust;    if readfirstmain(cCUr,1,true) then begin end;    if readfirstmain(CUr,1,true) then begin      if readrecordlink(CUr,1,SMFr,RLr) or FindSMURecord(CUr.Code,SMFr) then begin        if (SMFr.SMFCode == comp and cCUr.Code == SMFr.CustCode) then begin          if foundf then begin            RecordCopy(oldCUr,tCUr);            tCUr.Name = name;            tCUr.AllowLogin = 1;            tCUr.Comment = GenerateRandomHash;            tCUr.blockedFlag = 0;            tCUr.Classification = JALClassbl.Schoolar;            tCUr.Password = CalcPassword(tstr,tCUr.Code,0);            if recordUpdate(oldCUr,tCUr,true)== 0 then begin               if (ReadRecordLink(tCUr,1,SMFr,RLr)) then begin                RecordRemove(RLr);              end;              CreateRecordLink(SMFr,CurrentCompany,tCUr,CurrentCompany);              CreateRecordLink(tCUr,CurrentCompany,SMFr,CurrentCompany);              text = USetStr(32347) & chr(13) & USetStr(10018) & " " & email &  chr(13) & USetStr(10029) & ": " & tstr;              GenMailForSMU(text,USetStr(32348),tCUr.eMail,SMFr,false,tCUr,tstr);               end;            savef = true;          end else begin            RecordNew(CUr);            if (GetNextCustNr(tstr2)) then begin end;            CUr.Code = tstr2;            CUr.Name = name;            CUr.eMail = email;            CUr.CUType = 1;            CUr.Classification = JALClassbl.Schoolar;            CUr.AllowLogin = 1;            CUr.Comment = GenerateRandomHash;            SCr.SchoolCode = SMFr.SchoolCode;            CUr.Password = CalcPassword(tstr,CUr.Code,0);            if recordStore(CUr,true) then begin               if readfirstmain(SCr,1,true) then begin                CreateRecordLink(CUr,currentcompany,SCr,currentcompany);              end;              CreateRecordLink(SMFr,CurrentCompany,CUr,CurrentCompany);              CreateRecordLink(CUr,CurrentCompany,SMFr,CurrentCompany);              text = USetStr(32347) & chr(13) & USetStr(10018) & " " & email &  chr(13) & USetStr(10029) & ": " & tstr;              GenMailForSMU(text,USetStr(32348),CUr.eMail,SMFr,false,CUr,tstr);             end;            savef = true;          end;        end;      end;    end;  end;  if savef then begin    PutSessionString("ename","");    PutSessionString("eemail","");    PutSessionString("err","");    ShowRedirectHTML(FormatSimpleLink(GetLinkToStruct(JALClassbl.ProfileCorrectionStruct,true),true),false);  end else begin    PutSessionString("ename",name);    PutSessionString("eemail",email);    PutSessionString("err",err);    ShowRedirectHTML(FormatSimpleLink(WebGetArg("regpath"),true),false);  end;return;end;globalupdating procedure QRemoveRecordLink(record RLinkVc RLr)begin  RecordDelete(RLr);  return;end;globalupdating procedure QCreateRecordLinks(record SMFVc SMFr,record CUVc tCUr)begin  CreateRecordLink(SMFr,CurrentCompany,tCUr,CurrentCompany);  CreateRecordLink(tCUr,CurrentCompany,SMFr,CurrentCompany);  return;end;globalupdating procedure RemoveSMFLinks(record CUVc CUr)begin  record RLinkVc RLr,RL2r;  Integer i;  record SMFVc SMFr;    i = 1;  while (ReadRecordLink(CUr,i,SMFr,RL2r)) begin    QRemoveRecordLink(RL2r);    i = i +1;  end;  return;end;global webpublicprocedure WebSaveCompEmp2()begin  record JALClassBlock JALClassbl;  boolean TrHs;  record SchoolVc SCr;  record RLinkVc RLr,RL2r;  record CUVc CUr,tCUr;  record SMFVc SMFr;  Integer i;  BlockLoad(JALClassbl);  CUr.Code = CurrentCust;  if readfirstmain(CUr,1,true) then begin    if readrecordlink(CUr,1,SMFr,RLr) or FindSMURecord(CUr.Code,SMFr) then begin      if (SMFr.CustCode==CurrentCust) then begin        tCUr.Code = WebGetArg("nemp");        if (nonblank(tCUr.Code) and ReadFirstMain(tCUr,1,true)) then begin        /*          i = 1;          while (ReadRecordLink(tCUr,i,SMFr,RL2r)) begin            queued.QRemoveRecordLink(RL2r);            i = i +1;          end;          */          queued.RemoveSMFLinks(tCUr);          if (ReadFirstMain(tCUr,1,true) and ReadFirstMain(SMFr,1,true)) then begin            qupdating.QCreateRecordLinks(SMFr,tCUr);          end;        end;      end;    end;  end;  ShowRedirectHTML(FormatSimpleLink(GetLinkToStruct(JALClassbl.ProfileCorrectionStruct,true),true),false);    return;end;global webpublicupdating procedure WebChangeCompEmp()begin  record CUVc CUr,tCUr,cCUr,oldCUr;  record SMFVc SMFr,oldSMFr;  string 100 name,email,cust,comp,tstr,passw2;  record JALClassBlock JALClassbl;  boolean TrHs;  record SchoolVc SCr;  integer err;  boolean foundf,savef;  record RLinkVc RLr;  string 255 text;  string 60 manemail,oldemail,telephone;  err = 0;  BlockLoad(JALClassbl);    comp = webgetArg("smu");  cust = webGetArg("cust");  name = WebGetArg("name");  email = WebGetArg("email");  tstr = WebGetArg("passw1");  passw2 = WebGetArg("passw2");  telephone = WebGetArg("telephone");  if nonblank(tstr) then begin    if tstr <> passw2 then begin      err = err + 64;    end;  end;  if blank(name) then begin    err = err + 2;  end;  tCUr.Code = cust;  if readfirstmain(tCUr,1,true) then begin oldemail = tCUr.eMail; end;  foundf = false;  if blank(email) then begin    err = err + 4;  end else begin    if CheckEmailStr(email) == false then begin      err = err + 8;    end else begin      if email <> tCUr.eMail then begin        tCUr.eMail = email;        TrHs = true;        ResetLoop(tCUr);        if readfirstkey("eMail",tCUr,1,true) begin          if SetInSet(JALClassbl.EventPart,tCUr.Classification)==false and (tCUr.blockedFlag == 0) then begin            err = err + 16;          end;        end;      end;    end;  end;  savef = false;  if err == 0 then begin    cCUr.Code = CurrentCust ;    if readfirstmain(cCUr,1,true) then begin manemail = cCUr.eMail; end;        CUr.Code = cust;    if readfirstmain(CUr,1,true) then begin      if readrecordlink(CUr,1,SMFr,RLr) or FindSMURecord(cCUr.Code,SMFr) then begin        if SMFr.SMFCode == comp then begin          if (cust == cCUr.Code or cCUr.Code == SMFr.CustCode) then begin              RecordCopy(oldCUr,CUr);              CUr.Name = name;              CUr.eMail = email;              if(nonblank(telephone))then begin              	CUr.Phone = telephone;              end;              //stopalert(email & " eee " & cust & ";" & manemail & ";" & CurrentCust);              CUr.blockedFlag = 0;              CUr.Classification = JALClassbl.Schoolar;              if nonblank(tstr) then begin                CUr.Password = CalcPassword(tstr,CUr.Code,0);              end;              if recordUpdate(oldCUr,CUr,true)== 0 then begin end;              savef = true;              if oldemail == SMFr.Email then begin                recordCopy(oldSMFr,SMFr);                SMFr.Manager = CUr.Name;                SMFr.Email = CUr.eMail;                if recordUpdate(oldSMFr,SMFr,true) == 0 then begin end;              end;          end;        end;      end;    end;  end;return;end;global webpublicupdating procedure WebChangeCompTch()begin  record CUVc CUr,tCUr,cCUr,oldCUr;  record SMFVc SMFr,oldSMFr;  string 100 name,email,cust,comp,tstr,passw2;  record JALClassBlock JALClassbl;  boolean TrHs;  record SchoolVc SCr;  integer err;  boolean foundf,savef;  record RLinkVc RLr;  string 255 text;  string 60 manemail,oldemail,telephone;  record TeacherVc Tchr;  err = 0;  BlockLoad(JALClassbl);    comp = webgetArg("smu");  cust = webGetArg("cust");  name = WebGetArg("name");  email = WebGetArg("email");  tstr = WebGetArg("passw1");  passw2 = WebGetArg("passw2");  telephone = WebGetArg("telephone");  if nonblank(tstr) then begin    if tstr <> passw2 then begin      err = err + 64;    end;  end;  if blank(name) then begin    err = err + 2;  end;  tCUr.Code = cust;  if readfirstmain(tCUr,1,true) then begin oldemail = tCUr.eMail; end;  foundf = false;  if blank(email) then begin    err = err + 4;  end else begin    if CheckEmailStr(email) == false then begin      err = err + 8;    end else begin      if email <> tCUr.eMail then begin        tCUr.eMail = email;        TrHs = true;        ResetLoop(tCUr);        if readfirstkey("eMail",tCUr,1,true) begin          if SetInSet(JALClassbl.EventPart,tCUr.Classification)==false and (tCUr.blockedFlag == 0) then begin            err = err + 16;          end;        end;      end;    end;  end;  savef = false;  if err == 0 then begin    cCUr.Code = CurrentCust;    if readfirstmain(cCUr,1,true) then begin manemail = cCUr.eMail; end;        CUr.Code = cust;    if readfirstmain(CUr,1,true) then begin      if readrecordlink(CUr,1,Tchr,RLr) or FindTchrRecord(cCUr.Code,Tchr) then begin        if Tchr.TeacherCode == comp then begin          if (cust == cCUr.Code or cCUr.Code == Tchr.CustCode) then begin						RecordCopy(oldCUr,CUr);						CUr.Name = name;						CUr.eMail = email;						if(nonblank(telephone))then begin							CUr.Phone = telephone;						end;						//stopalert(email & " eee " & cust & ";" & manemail & ";" & CurrentCust);						CUr.blockedFlag = 0;						CUr.Classification = JALClassbl.Teacher;						if nonblank(tstr) then begin							CUr.Password = CalcPassword(tstr,CUr.Code,0);						end;						if recordUpdate(oldCUr,CUr,true)== 0 then begin end;						savef = true;          end;        end;      end;    end;  end;  if savef then begin    PutSessionString("err","");    ShowRedirectHTML(FormatSimpleLink(WebGetArg("regpath"),true) & "?cust=" & cust,false);  end else begin    if err == 0 then begin      PutSessionString("err",err);      ShowRedirectHTML(FormatSimpleLink(GetLinkToStruct(JALClassbl.ProfileCorrectionStruct,true),true),false);    end else begin      PutSessionString("err",err);      ShowRedirectHTML(FormatSimpleLink(WebGetArg("regpath"),true) & "?cust=" & cust,false);    end;  end;return;end;