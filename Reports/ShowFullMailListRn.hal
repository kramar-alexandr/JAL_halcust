procedure DblMailVc(string dblstr,string l,Integer currepwn)begin  Integer wn;  record MailVc Mailr;  string 255 tstr;  if (nonblank(l)) then begin    tstr = l;  end else begin    tstr = dblstr;  end;  Mailr.SerNr = tstr;  if Readfirstmain(Mailr,1,true) then begin    wn = OpenWindow("MailDClass",0,1,"","",Mailr);  end;return;end;function string 20 RowTypeText(integer rowtype)begin  string 20 res;  switch rowtype begin    case 0: res = USetStr(32390);	  case 1: res = USetStr(32391);	  case 2: res = USetStr(32392);	  case 3: res = USetStr(32393);  end;  RowTypeText = res;return;end;function string 255 GetAddressLines(record MailVc Mailr,string email,integer charcnt)begin  row MailVc Mailrw;  integer rw,rwc;  string 255 resstr;  rwc = MatRowCnt(Mailr);  for (rw = 0; rw < rwc; rw =rw + 1) begin    MatRowGet(Mailr,rw,Mailrw);	if Mailrw.AddrCode <> email then begin	  resstr = resstr & RowTypeText(Mailrw.RowTyp)  &  Mailrw.AddrCode & " " ;	end;  end;  GetAddressLines = resstr;return;end;function string 255 GetFirstLines(record MailVc Mailr,integer charcnt)BEGIN  Integer i,rwcnt;  string 255 tstr,resstr;  rwcnt = LineTextCnt(Mailr);  for (i=0;i<rwcnt;i=i+1) begin    tstr = LineTextGet(Mailr,i);    resstr = left(resstr & " " & tstr,charcnt);	if len(resstr)==charcnt then begin i = rwcnt; end;  end;  GetFirstLines = resstr;  RETURN;END;procedure PrintMailRec(record MailVc Mailr,string email)begin  StartFormat(15);  OutStringID(20,"DblMailVc",Mailr.TransDate,false,Mailr.SerNr);  OutString(90,0,Mailr.TransTime,false);  OutString(140,0,GetAddressLines(Mailr,email,50),false);  EndFormat;  StartFormat(15);  OutString(140,0,USetStr(32396) & left(Mailr.Header,30),false);  EndFormat;  StartFormat(20);  OutString(140,0,USetStr(32397) & GetFirstLines(Mailr,120),false);  EndFormat;return;end;global procedure ShowCompMailRn(record RCVc RepSpec)begin  record SMFVc SMFr;  record CUVc CUr;  record MailVc Mailr;  boolean foundf,firstf;  integer i,cnt,glcnt;  record RLinkVc RLr;  StartReportJob(USetStr(32399));  EndHeader;  SetRepCol(2,50);  SetRepCol(3,140);  SetRepCol(4,100);  foundf = true;  firstf = true;  cnt = 0;  glcnt = 0;  SMFr.SMFCode = RepSpec.f1;  if readfirstmain(SMFr,1,true) then begin        ResetLoop(Mailr);    //Mailr.TransDate =AddDay(CurrentDate,1000);    startformat(15);      //outstring(2,0,SMFr.Email & ";" & Mailr.TransDate,false);    endformat;    Mailr.TransDate = AddDay(CurrentDate,10);    CUr.Code = SMFr.CustCode;    if readfirstmain(CUr,1,true) then begin      while LoopBackKey("UserCustTime:" & CUr.eMail,Mailr,1,true) begin        if Firstf then begin          CUr.Code = SMFr.CustCode;          if readfirstmain(CUr,1,true) then begin            StartFormat(15);            OutString(0,0,USetStr(32394),false);            OutString(2,0,CUr.Name,false);            OutString(3,0,CUr.eMail,false);            EndFormat;          end;          Firstf = false;          startformat(1);            Gray_Divider(0,1);          endformat;        end;                PrintMailRec(Mailr,CUr.eMail);        cnt = cnt + 1;              end;    end;    glcnt = glcnt + cnt;    startformat(1);      Gray_Divider(0,1);    endformat;    startformat(15);      OutString(0,0,USetStr(32263),false);      OutString(2,0,cnt,false);    endformat;    startformat(1);      Black_Divider(0,1);    endformat;        i = 1;    while ReadRecordLink(SMFr,i,CUr,RLr) begin      if CUr.Code <> SMFr.CustCode then begin        foundf = true;        firstf = true;        cnt = 0;        ResetLoop(Mailr);        Mailr.TransDate = AddDay(CurrentDate,10);        //Mailr.TransTime = "";        while LoopBackKey("UserCustTime:" & CUr.eMail,Mailr,1,foundf) begin          if firstf then begin            StartFormat(15);            OutString(0,0,USetStr(32395),false);            OutString(2,0,CUr.Name,false);            OutString(3,0,CUr.eMail,false);            EndFormat;            Firstf = false;            startformat(1);              Gray_Divider(0,1);            endformat;          end;          PrintMailRec(Mailr,CUr.eMail);          cnt = cnt + 1;                  end;        if cnt == 0 then begin          StartFormat(15);          OutString(0,0,USetStr(32395),false);          OutString(2,0,CUr.Name,false);          OutString(3,0,CUr.eMail,false);          EndFormat;        end;        glcnt = glcnt + cnt;        startformat(1);          Gray_Divider(0,1);        endformat;        startformat(15);          OutString(0,0,USetStr(32263),false);          OutString(2,0,cnt,false);        endformat;        startformat(1);          Black_Divider(0,1);        endformat;      end;      i = i + 1;    end;    startformat(15);      OutString(0,0,USetStr(32398),false);      OutString(2,0,glcnt,false);    endformat;  end else begin  end;    EndJob;return;end;